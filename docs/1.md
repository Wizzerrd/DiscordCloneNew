# DiscordClone ‚Äî PART 1: Frontend Infrastructure (AWS S3 + CloudFront + GitHub CI/CD)

This section covers:
1. Creating IAM policies & a CI/CD user  
2. Configuring the AWS CLI  
3. Deploying S3 + CloudFront via CloudFormation  
4. Setting up GitHub Actions for continuous deployment  

---

## üß© 1Ô∏è‚É£ Create IAM User and Policies

Log in as your **admin user** (from Part 0) and perform the following.

### 1. Create IAM User
- **Name:** `discordclone-ci`  
- **Access type:** Programmatic access only  
- **No console login**

### 2. Attach Policies

#### `discord-ci-policy`
```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "cloudfront:CreateDistribution",
                "cloudfront:GetDistribution",
                "cloudfront:GetDistributionConfig",
                "cloudfront:UpdateDistribution",
                "cloudfront:DeleteDistribution",
                "cloudfront:TagResource",
                "cloudfront:CreateCloudFrontOriginAccessIdentity",
                "cloudfront:ListCloudFrontOriginAccessIdentities",
                "cloudfront:GetCloudFrontOriginAccessIdentityConfig",
                "cloudfront:DeleteCloudFrontOriginAccessIdentity",
                "cloudfront:CreateInvalidation"
            ],
            "Resource": "*"
        },
        {
            "Effect": "Allow",
            "Action": [
                "cloudformation:CreateStack",
                "cloudformation:UpdateStack",
                "cloudformation:DescribeStacks",
                "cloudformation:DescribeStackEvents",
                "cloudformation:DescribeStackResources",
                "cloudformation:GetTemplate",
                "cloudformation:GetTemplateSummary",
                "cloudformation:ValidateTemplate",
                "cloudformation:DeleteStack",
                "cloudformation:CreateChangeSet",
                "cloudformation:ExecuteChangeSet",
                "cloudformation:ListChangeSets"
            ],
            "Resource": "*"
        },
        {
            "Effect": "Allow",
            "Action": [
                "s3:*"
            ],
            "Resource": "*"
        },
        {
            "Effect": "Allow",
            "Action": [
                "iam:CreateServiceLinkedRole"
            ],
            "Resource": "*"
        }
    ]
}
```

---

## üß© 2Ô∏è‚É£ Configure AWS CLI

On your development machine:

```bash
aws configure --profile discordclone-ci
# AWS Access Key ID: <from IAM user>
# AWS Secret Access Key: <from IAM user>
# Default region name: us-west-1
# Default output format: json
```

Verify:
```bash
aws sts get-caller-identity --profile discordclone-ci
```

You should see your account and user ARN.

---

## üß© 3Ô∏è‚É£ Deploy Infrastructure (S3 + CloudFront)

Save as `infra/frontend-s3-cloudfront.yml`:

```yaml
AWSTemplateFormatVersion: "2010-09-09"
Description: DiscordClone frontend static site hosting (S3 + CloudFront)

Parameters:
  BucketName:
    Type: String
    Description: S3 bucket name for hosting the React build

Resources:
  FrontendBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Ref BucketName
      WebsiteConfiguration:
        IndexDocument: index.html
        ErrorDocument: index.html
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerPreferred

  CloudFrontOAI:
    Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
    Properties:
      CloudFrontOriginAccessIdentityConfig:
        Comment: Access identity for CloudFront to read from S3

  BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref FrontendBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: AllowCloudFrontRead
            Effect: Allow
            Principal:
              CanonicalUser: !GetAtt CloudFrontOAI.S3CanonicalUserId
            Action: "s3:GetObject"
            Resource: !Sub "arn:aws:s3:::${BucketName}/*"

  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        DefaultRootObject: index.html
        Origins:
          - Id: FrontendOrigin
            DomainName: !GetAtt FrontendBucket.RegionalDomainName
            S3OriginConfig:
              OriginAccessIdentity: !Sub "origin-access-identity/cloudfront/${CloudFrontOAI}"
        DefaultCacheBehavior:
          TargetOriginId: FrontendOrigin
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods: ["GET", "HEAD"]
          CachedMethods: ["GET", "HEAD"]
          ForwardedValues:
            QueryString: false
        ViewerCertificate:
          CloudFrontDefaultCertificate: true
        PriceClass: PriceClass_100
        HttpVersion: http2
        Comment: DiscordCloneNew frontend distribution

Outputs:
  BucketName:
    Description: Name of the S3 bucket hosting the static site
    Value: !Ref BucketName
  CloudFrontURL:
    Description: CloudFront URL for the hosted React app
    Value: !Sub "https://${CloudFrontDistribution.DomainName}"
```

Deploy:
```bash
aws cloudformation deploy \
  --template-file infra/frontend-s3-cloudfront.yml \
  --stack-name discordclone-frontend \
  --parameter-overrides BucketName=discordclonenew-frontend-luis \
  --capabilities CAPABILITY_NAMED_IAM \
  --region us-west-1 \
  --profile discordclone-ci \
  --no-fail-on-empty-changeset
```

Check progress:
```bash
aws cloudformation describe-stacks \
  --stack-name discordclone-frontend \
  --region us-west-1 \
  --profile discordclone-ci \
  --query "Stacks[0].StackStatus"
```

Retrieve CloudFront URL:
```bash
aws cloudformation describe-stacks \
  --stack-name discordclone-frontend \
  --region us-west-1 \
  --profile discordclone-ci \
  --query "Stacks[0].Outputs[?OutputKey=='CloudFrontURL'].OutputValue" \
  --output text
```

### üß† Executing the Change Set (Manual Review Mode)

If you run a CloudFormation deployment command and the stack remains stuck in:

```
"REVIEW_IN_PROGRESS"
```

it means CloudFormation created a **Change Set** (a preview of actions to apply) but didn‚Äôt automatically execute it.

---

#### üîç What is a Change Set?

A **Change Set** is CloudFormation‚Äôs way of showing what it *would* do before actually creating or updating resources.

Normally, `aws cloudformation deploy` executes automatically ‚Äî but if permissions or flags prevented that (e.g., no `--no-execute-changeset` option), you might need to trigger it manually.

---

#### üß© 1Ô∏è‚É£ List available Change Sets
Use this to find the latest Change Set name:

```bash
aws cloudformation list-change-sets \
  --stack-name discordclone-frontend \
  --region us-west-1 \
  --profile discordclone-ci
```

This will output something like:
```json
{
  "Summaries": [
    {
      "ChangeSetName": "awscli-cloudformation-package-deploy-1762363789",
      "ExecutionStatus": "AVAILABLE",
      "Status": "CREATE_COMPLETE"
    }
  ]
}
```

Copy the `ChangeSetName` value.

---

#### üß© 2Ô∏è‚É£ Execute the Change Set
Now execute it to apply your stack changes:

```bash
aws cloudformation execute-change-set \
  --change-set-name awscli-cloudformation-package-deploy-1762363789 \
  --stack-name discordclone-frontend \
  --region us-west-1 \
  --profile discordclone-ci
```

> üí° Replace the `--change-set-name` value with the one you copied from the previous step.

This command instructs CloudFormation to *actually create or update* the stack resources described in the Change Set.

---

#### üß© 3Ô∏è‚É£ Watch the Progress

Monitor deployment status:

```bash
aws cloudformation describe-stacks \
  --stack-name discordclone-frontend \
  --region us-west-1 \
  --profile discordclone-ci \
  --query "Stacks[0].StackStatus"
```

Possible outputs:
| Status | Meaning |
|---------|----------|
| `CREATE_IN_PROGRESS` | Stack is building ‚Äî all good |
| `CREATE_COMPLETE` | Finished successfully |
| `ROLLBACK_IN_PROGRESS` | Error occurred ‚Äî check stack events |
| `DELETE_FAILED` | Some resources couldn‚Äôt be removed (often CloudFront OAI) |

---

#### ‚úÖ Once Complete

You can retrieve your CloudFront distribution URL:

```bash
aws cloudformation describe-stacks \
  --stack-name discordclone-frontend \
  --region us-west-1 \
  --profile discordclone-ci \
  --query "Stacks[0].Outputs[?OutputKey=='CloudFrontURL'].OutputValue" \
  --output text
```

This URL will look like:
```
https://d123abcde.cloudfront.net
```

That‚Äôs your **live frontend endpoint** served securely via CloudFront + S3 üéâ

---

## üß© 4Ô∏è‚É£ Configure GitHub Actions

Create `.github/workflows/deploy-frontend.yml`:

```yaml
name: Deploy Frontend to AWS

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies and build
        run: |
          cd frontend
          npm ci
          npm run build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-1

      - name: Deploy to S3
        run: |
          aws s3 sync frontend/dist s3://discordclonenew-frontend-luis --delete

      - name: Invalidate CloudFront cache
        run: |
          DISTRIBUTION_ID=$(aws cloudformation describe-stack-resources \
            --stack-name discordclone-frontend \
            --region us-west-1 \
            --query "StackResources[?ResourceType=='AWS::CloudFront::Distribution'].PhysicalResourceId" \
            --output text)
          echo "Invalidating distribution $DISTRIBUTION_ID"
          aws cloudfront create-invalidation --distribution-id "$DISTRIBUTION_ID" --paths "/*"
```

Add repo secrets:
- `AWS_ACCESS_KEY_ID`
- `AWS_SECRET_ACCESS_KEY`

---

## üîí 5Ô∏è‚É£ Security Recap

| Surface | Protection | Description |
|----------|-------------|--------------|
| S3 bucket | Private, BlockPublicAccess | Only CloudFront OAI can read |
| CloudFront | HTTPS enforced | `ViewerProtocolPolicy: redirect-to-https` |
| CI/CD | Scoped IAM user | Limited to deploy + invalidate cache |
| Credentials | Stored in GitHub Secrets | Never committed to code |

---

## ‚úÖ Result

- React app hosted privately in S3  
- Public access via CloudFront HTTPS only  
- CI/CD pipeline updates automatically on `main` push  
- No public bucket exposure  

Next ‚Üí **Part 2**: backend infrastructure (App Runner / API Gateway + Lambda + WebSocket integration)
