# DiscordClone ‚Äî PART 1: Frontend Infrastructure (AWS S3 + CloudFront + GitHub CI/CD)

This section covers:
1. Creating IAM policies & a CI/CD user  
2. Configuring the AWS CLI  
3. Deploying S3 + CloudFront via CloudFormation  
4. Setting up GitHub Actions for continuous deployment  

---

## üß© 1Ô∏è‚É£ Create IAM User and Policies

Log in as your **admin user** (from Part 0) and perform the following.

### 1. Create IAM User
- **Name:** `discordclone-ci`  
- **Access type:** Programmatic access only  
- **No console login**

### 2. Attach Policies

#### `discord-ci-policy`
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:PutObject",
        "s3:PutObjectAcl",
        "s3:DeleteObject",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::discordclonenew-frontend",
        "arn:aws:s3:::discordclonenew-frontend/*"
      ]
    },
    {
      "Effect": "Allow",
      "Action": [
        "cloudfront:CreateDistribution",
        "cloudfront:GetDistribution",
        "cloudfront:GetDistributionConfig",
        "cloudfront:UpdateDistribution",
        "cloudfront:DeleteDistribution",
        "cloudfront:TagResource",
        "cloudfront:CreateCloudFrontOriginAccessIdentity",
        "cloudfront:ListCloudFrontOriginAccessIdentities",
        "cloudfront:GetCloudFrontOriginAccessIdentityConfig",
        "cloudfront:DeleteCloudFrontOriginAccessIdentity",
        "cloudfront:CreateInvalidation"
      ],
      "Resource": "*"
    }
  ]
}
```

#### `DiscordCloneCloudFormationDeployPolicy`
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "cloudformation:CreateStack",
        "cloudformation:UpdateStack",
        "cloudformation:DescribeStacks",
        "cloudformation:DescribeStackEvents",
        "cloudformation:DescribeStackResources",
        "cloudformation:GetTemplate",
        "cloudformation:GetTemplateSummary",
        "cloudformation:ValidateTemplate",
        "cloudformation:DeleteStack",
        "cloudformation:CreateChangeSet",
        "cloudformation:ExecuteChangeSet",
        "cloudformation:ListChangeSets"
      ],
      "Resource": "*"
    },
    {
      "Effect": "Allow",
      "Action": "s3:*",
      "Resource": "*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "cloudfront:CreateDistribution",
        "cloudfront:GetDistribution",
        "cloudfront:GetDistributionConfig",
        "cloudfront:UpdateDistribution",
        "cloudfront:DeleteDistribution",
        "cloudfront:TagResource"
      ],
      "Resource": "*"
    },
    {
      "Effect": "Allow",
      "Action": "iam:CreateServiceLinkedRole",
      "Resource": "*"
    }
  ]
}
```

---

## üß© 2Ô∏è‚É£ Configure AWS CLI

On your development machine:

```bash
aws configure --profile discordclone-ci
# AWS Access Key ID: <from IAM user>
# AWS Secret Access Key: <from IAM user>
# Default region name: us-west-1
# Default output format: json
```

Verify:
```bash
aws sts get-caller-identity --profile discordclone-ci
```

You should see your account and user ARN.

---

## üß© 3Ô∏è‚É£ Deploy Infrastructure (S3 + CloudFront)

Save as `infra/frontend-s3-cloudfront.yml`:

```yaml
AWSTemplateFormatVersion: "2010-09-09"
Description: DiscordClone frontend static site hosting (S3 + CloudFront)

Parameters:
  BucketName:
    Type: String
    Description: S3 bucket name for hosting the React build

Resources:
  FrontendBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Ref BucketName
      WebsiteConfiguration:
        IndexDocument: index.html
        ErrorDocument: index.html
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerPreferred

  CloudFrontOAI:
    Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
    Properties:
      CloudFrontOriginAccessIdentityConfig:
        Comment: Access identity for CloudFront to read from S3

  BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref FrontendBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: AllowCloudFrontRead
            Effect: Allow
            Principal:
              CanonicalUser: !GetAtt CloudFrontOAI.S3CanonicalUserId
            Action: "s3:GetObject"
            Resource: !Sub "arn:aws:s3:::${BucketName}/*"

  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        DefaultRootObject: index.html
        Origins:
          - Id: FrontendOrigin
            DomainName: !GetAtt FrontendBucket.RegionalDomainName
            S3OriginConfig:
              OriginAccessIdentity: !Sub "origin-access-identity/cloudfront/${CloudFrontOAI}"
        DefaultCacheBehavior:
          TargetOriginId: FrontendOrigin
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods: ["GET", "HEAD"]
          CachedMethods: ["GET", "HEAD"]
          ForwardedValues:
            QueryString: false
        ViewerCertificate:
          CloudFrontDefaultCertificate: true
        PriceClass: PriceClass_100
        HttpVersion: http2
        Comment: DiscordCloneNew frontend distribution

Outputs:
  BucketName:
    Description: Name of the S3 bucket hosting the static site
    Value: !Ref BucketName
  CloudFrontURL:
    Description: CloudFront URL for the hosted React app
    Value: !Sub "https://${CloudFrontDistribution.DomainName}"
```

Deploy:
```bash
aws cloudformation deploy \
  --template-file infra/frontend-s3-cloudfront.yml \
  --stack-name discordclone-frontend \
  --parameter-overrides BucketName=discordclonenew-frontend-luis \
  --capabilities CAPABILITY_NAMED_IAM \
  --region us-west-1 \
  --profile discordclone-ci \
  --no-fail-on-empty-changeset
```

Check progress:
```bash
aws cloudformation describe-stacks \
  --stack-name discordclone-frontend \
  --region us-west-1 \
  --profile discordclone-ci \
  --query "Stacks[0].StackStatus"
```

Retrieve CloudFront URL:
```bash
aws cloudformation describe-stacks \
  --stack-name discordclone-frontend \
  --region us-west-1 \
  --profile discordclone-ci \
  --query "Stacks[0].Outputs[?OutputKey=='CloudFrontURL'].OutputValue" \
  --output text
```

---

## üß© 4Ô∏è‚É£ Configure GitHub Actions

Create `.github/workflows/deploy-frontend.yml`:

```yaml
name: Deploy Frontend to AWS

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies and build
        run: |
          cd frontend
          npm ci
          npm run build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-1

      - name: Deploy to S3
        run: |
          aws s3 sync frontend/dist s3://discordclonenew-frontend-luis --delete

      - name: Invalidate CloudFront cache
        run: |
          DISTRIBUTION_ID=$(aws cloudformation describe-stack-resources \
            --stack-name discordclone-frontend \
            --region us-west-1 \
            --query "StackResources[?ResourceType=='AWS::CloudFront::Distribution'].PhysicalResourceId" \
            --output text)
          echo "Invalidating distribution $DISTRIBUTION_ID"
          aws cloudfront create-invalidation --distribution-id "$DISTRIBUTION_ID" --paths "/*"
```

Add repo secrets:
- `AWS_ACCESS_KEY_ID`
- `AWS_SECRET_ACCESS_KEY`

---

## üîí 5Ô∏è‚É£ Security Recap

| Surface | Protection | Description |
|----------|-------------|--------------|
| S3 bucket | Private, BlockPublicAccess | Only CloudFront OAI can read |
| CloudFront | HTTPS enforced | `ViewerProtocolPolicy: redirect-to-https` |
| CI/CD | Scoped IAM user | Limited to deploy + invalidate cache |
| Credentials | Stored in GitHub Secrets | Never committed to code |

---

## ‚úÖ Result

- React app hosted privately in S3  
- Public access via CloudFront HTTPS only  
- CI/CD pipeline updates automatically on `main` push  
- No public bucket exposure  

Next ‚Üí **Part 2**: backend infrastructure (App Runner / API Gateway + Lambda + WebSocket integration)
